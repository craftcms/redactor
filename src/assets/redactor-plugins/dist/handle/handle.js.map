{"version":3,"sources":["handle/handle.js"],"names":["$R","add","init","app","this","opts","$doc","$body","editor","marker","keycodes","container","selection","handleTrigger","handleStart","handleStr","handleLen","start","handle","$editor","getElement","on","_handle","bind","_listen","stop","off","dom","remove","e","key","which","ctrl","ctrlKey","metaKey","BACKSPACE","_isShown","_hide","DELETE","ESC","SHIFT","indexOf","re","RegExp","getTextBeforeCaret","test","replace","_load","$item","ks","ENTER","_getActiveItem","length","_hideForce","preventDefault","_replace","$first","_getFirstItem","_setActive","_setNextActive","_setPrevActive","_getItems","$list","find","filter","node","hasClass","first","_getLastItem","last","$el","removeClass","addClass","itemHeight","outerHeight","itemTop","position","top","itemsScrollTop","scrollTop","itemsHeight","$next","next","$prev","prev","$last","ajax","post","url","data","success","_parse","json","JSON","parse","_build","_buildData","append","_update","_show","html","item","attr","offset","pos","getPosition","css","height","left","show","hidable","type","SPACE","hide","_reset","target","replacement","insert","$marker","current","previousSibling","currentText","textContent","before","restoreMarkers","Redactor"],"mappings":"CAAA,SAAUA,GAENA,EAAGC,IAAI,SAAU,SAAU,CACvBC,KAAM,SAASC,GAEXC,KAAKD,IAAMA,EACXC,KAAKC,KAAOF,EAAIE,KAChBD,KAAKE,KAAOH,EAAIG,KAChBF,KAAKG,MAAQJ,EAAII,MACjBH,KAAKI,OAASL,EAAIK,OAClBJ,KAAKK,OAASN,EAAIM,OAClBL,KAAKM,SAAWP,EAAIO,SACpBN,KAAKO,UAAYR,EAAIQ,UACrBP,KAAKQ,UAAYT,EAAIS,UAGrBR,KAAKS,mBAAoD,IAA5BT,KAAKC,KAAKQ,cAAiCT,KAAKC,KAAKQ,cAAgB,IAClGT,KAAKU,iBAAgD,IAA1BV,KAAKC,KAAKS,YAA+BV,KAAKC,KAAKS,YAAc,EAC5FV,KAAKW,UAAY,GACjBX,KAAKY,UAAYZ,KAAKU,aAG1BG,MAAO,WAEH,GAAKb,KAAKC,KAAKa,OAAf,CAEA,IAAIC,EAAUf,KAAKI,OAAOY,aACnCD,EAAQE,GAAG,+BAAgCjB,KAAKkB,QAAQC,KAAKnB,OACpDe,EAAQE,GAAG,iCAAkCjB,KAAKoB,QAAQD,KAAKnB,SAEzEqB,KAAM,WAEkBrB,KAAKI,OAAOY,aAE3BM,IAAI,2BACHtB,KAAKE,KAAKoB,IAAI,2BAEF1B,EAAG2B,IAAI,yBACbC,UAIhBN,QAAS,SAASO,GAEd,IAAIC,EAAMD,EAAEE,MACXC,EAAOH,EAAEI,SAAWJ,EAAEK,QAGjB,GAAIJ,IAAQ1B,KAAKM,SAASyB,UAC1B,CACI,KAAI/B,KAAKgC,YAAehC,KAAKY,UAAYZ,KAAKU,aAU1C,OARAV,KAAKY,UAAYZ,KAAKY,UAAY,EAC9BZ,KAAKY,WAAaZ,KAAKU,aAEvBV,KAAKiC,QAS1B,GAAIP,IAAQ1B,KAAKM,SAAS4B,QACnBR,IAAQ1B,KAAKM,SAAS6B,KACtBT,IAAQ1B,KAAKM,SAAS8B,QACtBR,IAC0B,IAtBpB,CAAC,GAAI,GAAI,GAAI,IAsBXS,QAAQX,GAJvB,CAUS,IAAIY,EAAK,IAAIC,OAAO,IAAMvC,KAAKS,eAC/BT,KAAKW,UAAYX,KAAKQ,UAAUgC,mBAAmBxC,KAAKY,UAAY,GAGhE0B,EAAGG,KAAKzC,KAAKW,aAEbX,KAAKW,UAAYX,KAAKW,UAAU+B,QAAQ1C,KAAKS,cAAe,IAC5DT,KAAKY,YAELZ,KAAK2C,WAGbvB,QAAS,SAASK,GACd,IAsBQmB,EAtBJlB,EAAMD,EAAEE,MACRkB,EAAK7C,KAAKM,SAGd,GAAIN,KAAKgC,YAAcN,IAAQmB,EAAGC,MAE9B,OAAqB,KADjBF,EAAQ5C,KAAK+C,kBACPC,YACNhD,KAAKiD,cAILxB,EAAEyB,iBACFlD,KAAKmD,SAAS1B,EAAGmB,QACjB5C,KAAKiD,cAMb,IAAIjD,KAAKgC,YAAuB,KAARN,GAAsB,KAARA,QAIlC,GAHAD,EAAEyB,iBAGmB,KADjBN,EAAQ5C,KAAK+C,kBACPC,OAAc,CACpB,IAAII,EAASpD,KAAKqD,gBAClBrD,KAAKsD,WAAWF,QAGH,KAAR1B,EACL1B,KAAKuD,eAAeX,GAGP,KAARlB,GACL1B,KAAKwD,eAAeZ,IAMhCa,UAAW,WACP,OAAOzD,KAAK0D,MAAMC,KAAK,MAE3BZ,eAAgB,WACZ,OAAO/C,KAAKyD,YAAYG,QAAO,SAASC,GACpC,OAAOjE,EAAG2B,IAAIsC,GAAMC,SAAS,cAGrCT,cAAe,WACX,OAAOrD,KAAKyD,YAAYM,SAE5BC,aAAc,WACV,OAAOhE,KAAKyD,YAAYQ,QAE5BX,WAAY,SAASY,GACjBlE,KAAKyD,YAAYU,YAAY,UAC7BD,EAAIE,SAAS,UAEb,IAAIC,EAAaH,EAAII,cACjBC,EAAUL,EAAIM,WAAWC,IACzBC,EAAiB1E,KAAK0D,MAAMiB,YAC5BA,EAAYJ,EAAuB,EAAbF,EACtBO,EAAc5E,KAAK0D,MAAMY,cAE7BtE,KAAK0D,MAAMiB,UACPA,EAAYD,EAAiBE,EAAcD,EAAYC,EACnDL,EAAUF,EAAaK,EAAiBH,EAAUF,EAClDK,IAGZnB,eAAgB,SAASW,GACrB,IAAIW,EAAQX,EAAIY,OAChB,GAAqB,IAAjBD,EAAM7B,OACNhD,KAAKsD,WAAWuB,OAEf,CACD,IAAIzB,EAASpD,KAAKqD,gBAClBrD,KAAKsD,WAAWF,KAGxBI,eAAgB,SAASU,GACrB,IAAIa,EAAQb,EAAIc,OAChB,GAAqB,IAAjBD,EAAM/B,OACNhD,KAAKsD,WAAWyB,OAEf,CACD,IAAIE,EAAQjF,KAAKgE,eACjBhE,KAAKsD,WAAW2B,KAG9BtC,MAAO,WAEH/C,EAAGsF,KAAKC,KAAK,CACTC,IAAKpF,KAAKC,KAAKa,OACfuE,KAAM,UAAYrF,KAAKW,UACvB2E,QAAStF,KAAKuF,OAAOpE,KAAKnB,SAGlCuF,OAAQ,SAASC,GAEb,GAAa,KAATA,EAAJ,CAEM,IAAIH,EAAwB,iBAATG,EAAqBA,EAAOC,KAAKC,MAAMF,GAE1DxF,KAAK2F,SACL3F,KAAK4F,WAAWP,KAE1BM,OAAQ,WAEE3F,KAAK0D,MAAQ9D,EAAG2B,IAAI,yBACM,IAAtBvB,KAAK0D,MAAMV,SAEXhD,KAAK0D,MAAQ9D,EAAG2B,IAAI,mCACpBvB,KAAKG,MAAM0F,OAAO7F,KAAK0D,SAG/BkC,WAAY,SAASP,GAEjBrF,KAAKqF,KAAOA,EAEZrF,KAAK8F,UACL9F,KAAK+F,SAETD,QAAS,WAIL,IAAK,IAAIpE,KAFT1B,KAAK0D,MAAMsC,KAAK,IAEAhG,KAAKqF,KACrB,CACI,IAAIzC,EAAQhD,EAAG2B,IAAI,gBACnBqB,EAAMoD,KAAKhG,KAAKqF,KAAK3D,GAAKuE,MAC1BrD,EAAMsD,KAAK,WAAYxE,GACvBkB,EAAM3B,GAAG,QAASjB,KAAKmD,SAAShC,KAAKnB,OAErCA,KAAK0D,MAAMmC,OAAOjD,GAIX5C,KAAKO,UAAUS,aACOmF,SADvC,IAEUC,EAAMpG,KAAKQ,UAAU6F,cAEzBrG,KAAK0D,MAAMU,SAAS,QACpBpE,KAAK0D,MAAM4C,IAAI,CACX7B,IAAM2B,EAAI3B,IAAM2B,EAAIG,OAASvG,KAAKE,KAAKyE,YAAe,KACtD6B,KAAMJ,EAAII,KAAO,QAGzBxE,SAAU,WAEN,OAAQhC,KAAK0D,OAAS1D,KAAK0D,MAAMI,SAAS,SAE9CiC,MAAO,WAEH/F,KAAK0D,MAAMU,SAAS,QACpBpE,KAAK0D,MAAM+C,OAEXzG,KAAKE,KAAKoB,IAAI,2BACdtB,KAAKE,KAAKe,GAAG,8DAA+DjB,KAAKiC,MAAMd,KAAKnB,QAEhGiC,MAAO,SAASR,GAEZ,IAAIiF,GAAU,EACVhF,EAAOD,GAAKA,EAAEE,MAEbF,GACe,UAAXA,EAAEkF,MAAoBjF,IAAQ1B,KAAKM,SAAS6B,KAAOT,IAAQ1B,KAAKM,SAASsG,QAD1EF,GAAU,GAGdA,GACD1G,KAAKiD,cAGZA,WAAY,WACRjD,KAAK0D,MAAMS,YAAY,QACvBnE,KAAK0D,MAAMmD,OACX7G,KAAK8G,UAETA,OAAQ,WAEJ9G,KAAKW,UAAY,GACjBX,KAAKY,UAAYZ,KAAKU,aAEhCyC,SAAU,SAAS1B,EAAGyC,GAElBzC,EAAEyB,iBAEF,IACIxB,GADQ,GAAc9B,EAAG2B,IAAIE,EAAEsF,SACnBb,KAAK,YACjBc,EAAchH,KAAKqF,KAAK3D,GAAKsF,YAE7B3G,EAASL,KAAKK,OAAO4G,OAAO,SAC5BC,EAAUtH,EAAG2B,IAAIlB,GACX8G,EAAU9G,EAAO+G,gBACjBC,EAAcF,EAAQG,YACtBhF,EAAK,IAAIC,OAAOvC,KAAKS,cAAgBT,KAAKW,UAAY,KAE7D0G,EAAcA,EAAY3E,QAAQJ,EAAI,IACtC6E,EAAQG,YAAcD,EAEnBH,EAAQK,OAAOP,GAEvBhH,KAAKQ,UAAUgH,oBA/RnB,CAoSGC","file":"handle.js","sourcesContent":["(function($R)\n{\n    $R.add('plugin', 'handle', {\n        init: function(app)\n        {\n            this.app = app;\n            this.opts = app.opts;\n            this.$doc = app.$doc;\n            this.$body = app.$body;\n            this.editor = app.editor;\n            this.marker = app.marker;\n            this.keycodes = app.keycodes;\n            this.container = app.container;\n            this.selection = app.selection;\n\n            // local\n            this.handleTrigger = (typeof this.opts.handleTrigger !== 'undefined') ? this.opts.handleTrigger : '@';\n            this.handleStart = (typeof this.opts.handleStart !== 'undefined') ? this.opts.handleStart : 0;\n            this.handleStr = '';\n            this.handleLen = this.handleStart;\n        },\n        // public\n        start: function()\n        {\n            if (!this.opts.handle) return;\n\n            var $editor = this.editor.getElement();\n\t\t\t$editor.on('keyup.redactor-plugin-handle', this._handle.bind(this));\n            $editor.on('keydown.redactor-plugin-handle', this._listen.bind(this));\n\t\t},\n\t\tstop: function()\n\t\t{\n            var $editor = this.editor.getElement();\n\n\t\t\t$editor.off('.redactor-plugin-handle');\n            this.$doc.off('.redactor-plugin-handle');\n\n            var $list = $R.dom('#redactor-handle-list');\n            $list.remove();\n\t\t},\n\n\t\t// private\n\t\t_handle: function(e)\n\t\t{\n    \t\tvar key = e.which;\n\t\t\tvar ctrl = e.ctrlKey || e.metaKey;\n\t\t\tvar arrows = [37, 38, 39, 40];\n\n            if (key === this.keycodes.BACKSPACE)\n            {\n                if (this._isShown() && (this.handleLen > this.handleStart))\n                {\n                    this.handleLen = this.handleLen - 2;\n                    if (this.handleLen <= this.handleStart)\n                    {\n                        this._hide();\n                    }\n                }\n                else\n                {\n                    return;\n                }\n            }\n\n\t\t\tif (key === this.keycodes.DELETE\n\t\t\t    || key === this.keycodes.ESC\n\t\t\t    || key === this.keycodes.SHIFT\n\t\t\t    || ctrl\n\t\t\t    || (arrows.indexOf(key) !== -1)\n\t\t\t)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n            var re = new RegExp('^' + this.handleTrigger);\n            this.handleStr = this.selection.getTextBeforeCaret(this.handleLen + 1);\n\n            // detect\n            if (re.test(this.handleStr))\n            {\n                this.handleStr = this.handleStr.replace(this.handleTrigger, '');\n                this.handleLen++;\n\n                this._load();\n            }\n\t\t},\n        _listen: function(e) {\n            var key = e.which;\n            var ks = this.keycodes;\n\n            // listen enter\n            if (this._isShown() && key === ks.ENTER) {\n                var $item = this._getActiveItem();\n                if ($item.length === 0) {\n                    this._hideForce();\n                    return;\n                }\n                else {\n                    e.preventDefault();\n                    this._replace(e, $item);\n                    this._hideForce();\n                    return;\n                }\n            }\n\n            // listen down / up\n            if (this._isShown() && (key === 40 || key === 38)) {\n                e.preventDefault();\n\n                var $item = this._getActiveItem();\n                if ($item.length === 0) {\n                    var $first = this._getFirstItem();\n                    this._setActive($first);\n                }\n                // down\n                else if (key === 40) {\n                    this._setNextActive($item);\n                }\n                // up\n                else if (key === 38) {\n                    this._setPrevActive($item);\n                }\n\n                return;\n            }\n        },\n        _getItems: function() {\n            return this.$list.find('a');\n        },\n        _getActiveItem: function() {\n            return this._getItems().filter(function(node) {\n                return $R.dom(node).hasClass('active');\n            });\n        },\n        _getFirstItem: function() {\n            return this._getItems().first();\n        },\n        _getLastItem: function() {\n            return this._getItems().last();\n        },\n        _setActive: function($el) {\n            this._getItems().removeClass('active');\n            $el.addClass('active');\n\n            var itemHeight = $el.outerHeight();\n            var itemTop = $el.position().top;\n            var itemsScrollTop = this.$list.scrollTop();\n            var scrollTop = itemTop + itemHeight * 2;\n            var itemsHeight = this.$list.outerHeight();\n\n            this.$list.scrollTop(\n                scrollTop > itemsScrollTop + itemsHeight ? scrollTop - itemsHeight :\n                    itemTop - itemHeight < itemsScrollTop ? itemTop - itemHeight :\n                    itemsScrollTop\n            );\n        },\n        _setNextActive: function($el) {\n            var $next = $el.next();\n            if ($next.length !== 0) {\n                this._setActive($next);\n            }\n            else {\n                var $first = this._getFirstItem();\n                this._setActive($first);\n            }\n        },\n        _setPrevActive: function($el) {\n            var $prev = $el.prev();\n            if ($prev.length !== 0) {\n                this._setActive($prev);\n            }\n            else {\n                var $last = this._getLastItem();\n                this._setActive($last);\n            }\n        },\n\t\t_load: function()\n\t\t{\n    \t\t$R.ajax.post({\n        \t\turl: this.opts.handle,\n        \t\tdata: 'handle=' + this.handleStr,\n        \t\tsuccess: this._parse.bind(this)\n    \t\t});\n\t\t},\n\t\t_parse: function(json)\n\t\t{\n    \t\tif (json === '') return;\n\n            var data = (typeof json === 'object') ? json : JSON.parse(json);\n\n            this._build();\n            this._buildData(data);\n\t\t},\n\t\t_build: function()\n\t\t{\n            this.$list = $R.dom('#redactor-handle-list');\n            if (this.$list.length === 0)\n            {\n                this.$list = $R.dom('<div id=\"redactor-handle-list\">');\n                this.$body.append(this.$list);\n            }\n        },\n        _buildData: function(data)\n        {\n            this.data = data;\n\n            this._update();\n            this._show();\n        },\n        _update: function()\n        {\n            this.$list.html('');\n\n            for (var key in this.data)\n            {\n                var $item = $R.dom('<a href=\"#\">');\n                $item.html(this.data[key].item);\n                $item.attr('data-key', key);\n                $item.on('click', this._replace.bind(this));\n\n                this.$list.append($item);\n            }\n\n            // position\n    \t\tvar $container = this.container.getElement();\n            var containerOffset = $container.offset();\n            var pos = this.selection.getPosition();\n\n            this.$list.addClass('open');\n            this.$list.css({\n                top: (pos.top + pos.height + this.$doc.scrollTop()) + 'px',\n                left: pos.left + 'px'\n            });\n        },\n        _isShown: function()\n        {\n            return (this.$list && this.$list.hasClass('open'));\n        },\n        _show: function()\n        {\n            this.$list.addClass('open');\n            this.$list.show();\n\n            this.$doc.off('.redactor-plugin-handle');\n            this.$doc.on('click.redactor-plugin-handle keydown.redactor-plugin-handle', this._hide.bind(this));\n        },\n        _hide: function(e)\n        {\n            var hidable = false;\n            var key = (e && e.which);\n\n            if (!e) hidable = true;\n            else if (e.type === 'click' || key === this.keycodes.ESC || key === this.keycodes.SPACE) hidable = true;\n\n            if (hidable) {\n               this._hideForce();\n            }\n        },\n        _hideForce: function() {\n            this.$list.removeClass('open');\n            this.$list.hide();\n            this._reset();\n        },\n        _reset: function()\n        {\n            this.handleStr = '';\n            this.handleLen = this.handleStart;\n        },\n\t\t_replace: function(e, $el)\n\t\t{\n    \t\te.preventDefault();\n\n    \t\tvar $item = ($el) ? $el : $R.dom(e.target);\n    \t\tvar key = $item.attr('data-key');\n    \t\tvar replacement = this.data[key].replacement;\n\n    \t\tvar marker = this.marker.insert('start');\n    \t\tvar $marker = $R.dom(marker);\n            var current = marker.previousSibling;\n            var currentText = current.textContent;\n            var re = new RegExp(this.handleTrigger + this.handleStr + '$');\n\n        \tcurrentText = currentText.replace(re, '');\n        \tcurrent.textContent = currentText;\n\n            $marker.before(replacement);\n\n \t\t\tthis.selection.restoreMarkers();\n\n            return;\n\t\t}\n    });\n})(Redactor);"]}