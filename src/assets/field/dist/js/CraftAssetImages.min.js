var plugin=$.extend({},Craft.Redactor.PluginBase,{title:"image",apiTarget:"plugin.craftAssetImages.showModal",icon:'<i class="re-icon-image"></i>',transforms:[],volumes:null,allowAllUploaders:!1,defaultTransform:"",modalState:{selectedTransform:null},showModal:function(){if(this.saveSelection(this.app),void 0===this.assetSelectionModal){const e={siteId:this.elementSiteId,kind:"image"};this.allowAllUploaders&&(e.uploaderId=null),this.assetSelectionModal=Craft.createElementSelectorModal("craft\\elements\\Asset",{storageKey:"RedactorInput.ChooseImage",multiSelect:!0,sources:this.volumes,criteria:e,onSelect:function(e,t){if(e.length){this.restoreSelection(this.app);const s={},a=e.length>1,r=function(e,a){const o=e.pop(),n=this._isTransformUrl(o.url);if(n||0==this.defaultTransform.length)s["asset"+o.id]={url:this._buildAssetUrl(o.id,o.url,n?t:this.defaultTransform),id:o.id},e.length?r(e,a):a();else{this._getTransformUrl(o.id,this.defaultTransform,function(t){s["asset"+o.id]={url:this._buildAssetUrl(o.id,t,this.defaultTransform),id:o.id},e.length?r(e,a):a()}.bind(this))}}.bind(this);r(e,function(){this.app.api("module.image.insert",s),a||(this.modalState.selectedTransform=this.defaultTransform,this.app.api("module.image.open"))}.bind(this))}}.bind(this),transforms:this.transforms,closeOtherModals:!1})}else this.assetSelectionModal.show()},setTransforms:function(e){this.transforms=e},setDefaultTransform:function(e){this.defaultTransform=e},setVolumes:function(e){this.volumes=e},_buildAssetUrl:(e,t,s)=>t+"#asset:"+e+":"+(s?"transform:"+s:"url"),_removeTransformFromUrl:e=>e.replace(/(.*)(_[a-z0-9+].*\/)(.*)/,"$1$3"),_isTransformUrl:e=>/(.*)(_[a-z0-9+].*\/)(.*)/.test(e),_getTransformUrl:function(e,t,s){var a={assetId:e,handle:t};Craft.postActionRequest("assets/generate-transform",a,(function(e,t){"success"===t&&(e.url?s(e.url):alert("There was an error generating the transform URL."))}))},_getAssetUrlComponents:e=>{const t=e.match(/(.*)#asset:(\d+):(url|transform):?([a-zA-Z][a-zA-Z0-9_]*)?/);return t?{url:t[1],assetId:t[2],transform:"url"!==t[3]?t[4]:null}:null},onmodal:{imageedit:{open:function(e,t){this.registerCmdS(()=>{const e=this.app.module.image,t=this.app.module.modal;e._save(t.$modal,t.$modalForm)},()=>{this.app.api("module.modal.close")});const s=this._getAssetUrlComponents(this.app.module.image.$image.$element.nodes[0].src);if(!s)return;let{transform:a}=s;a&&a.length?this.modalState.selectedTransform=a:a=this.defaultTransform;const r=[{handle:"",name:"No transform"}].concat(this.transforms),o=$('<select id="modal-image-transform"></select>').on("change",function(e){this.modalState.selectedTransform=$(e.currentTarget).val()}.bind(this));for(optionIndex in r){let e=r[optionIndex],t=a&&e.handle==a;o.append('<option value="'+e.handle+'"'+(t?' selected="selected"':"")+">"+e.name+"</option>")}const n=$('<div class="form-item form-item-transform"><label for="modal-image-transform">Transform</label></div>').append(o);$(t.nodes[0]).append(n)},close:function(){Garnish.shortcutManager.removeLayer()}}},onimage:{changed:function(e){const t=$(e.$element.nodes[0]),s=this._getAssetUrlComponents(t.attr("src")),a=this.modalState.selectedTransform;if(!s)return;const{transform:r,assetId:o,url:n}=s;if(r!=a)if(t.fadeTo(100,.2),a.length)this._getTransformUrl(o,a,function(e){t.prop("src",this._buildAssetUrl(o,e,a)),t.stop().fadeTo(0,1)}.bind(this));else{new RegExp("(.*)(_"+r+".*/)(.*)");t.prop("src",this._buildAssetUrl(o,this._removeTransformFromUrl(n),a)),t.stop().fadeTo(0,1)}}}});Redactor.add("plugin","craftAssetImages",plugin);
//# sourceMappingURL=CraftAssetImages.min.js.map
