var plugin=$.extend({},Craft.Redactor.PluginBase,{title:"image",apiTarget:"plugin.craftAssetImages.showModal",icon:'<i class="re-icon-image"></i>',transforms:[],volumes:null,allowAllUploaders:!1,defaultTransform:"",modalState:{selectedTransform:null},showModal:function(){if(this.app.selection.isCollapsed()?(this.app.selection.save(),this.app.selectionMarkers=!1):(this.app.selection.saveMarkers(),this.app.selectionMarkers=!0),void 0===this.assetSelectionModal){const e={siteId:this.elementSiteId,kind:"image"};this.allowAllUploaders&&(e.uploaderId=null),this.assetSelectionModal=Craft.createElementSelectorModal("craft\\elements\\Asset",{storageKey:"RedactorInput.ChooseImage",multiSelect:!0,sources:this.volumes,criteria:e,onSelect:function(e,s){if(e.length){this.app.selectionMarkers?this.app.selection.restoreMarkers():this.app.selection.restore(),this.app.selectionMarkers=!1;const t={},a=e.length>1,r=function(e,a){const o=e.pop(),n=this._isTransformUrl(o.url);if(n||0==this.defaultTransform.length)t["asset"+o.id]={url:this._buildAssetUrl(o.id,o.url,n?s:this.defaultTransform),id:o.id},e.length?r(e,a):a();else{this._getTransformUrl(o.id,this.defaultTransform,function(s){t["asset"+o.id]={url:this._buildAssetUrl(o.id,s,this.defaultTransform),id:o.id},e.length?r(e,a):a()}.bind(this))}}.bind(this);r(e,function(){this.app.api("module.image.insert",t),a||(this.modalState.selectedTransform=this.defaultTransform,this.app.api("module.image.open"))}.bind(this))}}.bind(this),transforms:this.transforms,closeOtherModals:!1})}else this.assetSelectionModal.show()},setTransforms:function(e){this.transforms=e},setDefaultTransform:function(e){this.defaultTransform=e},setVolumes:function(e){this.volumes=e},_buildAssetUrl:(e,s,t)=>s+"#asset:"+e+":"+(t?"transform:"+t:"url"),_removeTransformFromUrl:e=>e.replace(/(.*)(_[a-z0-9+].*\/)(.*)/,"$1$3"),_isTransformUrl:e=>/(.*)(_[a-z0-9+].*\/)(.*)/.test(e),_getTransformUrl:function(e,s,t){var a={assetId:e,handle:s};Craft.postActionRequest("assets/generate-transform",a,(function(e,s){"success"===s&&(e.url?t(e.url):alert("There was an error generating the transform URL."))}))},_getAssetUrlComponents:e=>{const s=e.match(/(.*)#asset:(\d+):(url|transform):?([a-zA-Z][a-zA-Z0-9_]*)?/);return s?{url:s[1],assetId:s[2],transform:"url"!==s[3]?s[4]:null}:null},onmodal:{imageedit:{open:function(e,s){this.registerCmdS(()=>{const e=this.app.module.image,s=this.app.module.modal;e._save(s.$modal,s.$modalForm)},()=>{this.app.api("module.modal.close")});const t=this._getAssetUrlComponents(this.app.module.image.$image.$element.nodes[0].src);if(!t)return;let{transform:a}=t;a&&a.length?this.modalState.selectedTransform=a:a=this.defaultTransform;const r=[{handle:"",name:"No transform"}].concat(this.transforms),o=$('<select id="modal-image-transform"></select>').on("change",function(e){this.modalState.selectedTransform=$(e.currentTarget).val()}.bind(this));for(optionIndex in r){let e=r[optionIndex],s=a&&e.handle==a;o.append('<option value="'+e.handle+'"'+(s?' selected="selected"':"")+">"+e.name+"</option>")}const n=$('<div class="form-item form-item-transform"><label for="modal-image-transform">Transform</label></div>').append(o);$(s.nodes[0]).append(n)},close:function(){Garnish.shortcutManager.removeLayer()}}},onimage:{changed:function(e){const s=$(e.$element.nodes[0]),t=this._getAssetUrlComponents(s.attr("src")),a=this.modalState.selectedTransform;if(!t)return;const{transform:r,assetId:o,url:n}=t;if(r!=a)if(s.fadeTo(100,.2),a.length)this._getTransformUrl(o,a,function(e){s.prop("src",this._buildAssetUrl(o,e,a)),s.stop().fadeTo(0,1)}.bind(this));else{new RegExp("(.*)(_"+r+".*/)(.*)");s.prop("src",this._buildAssetUrl(o,this._removeTransformFromUrl(n),a)),s.stop().fadeTo(0,1)}}}});Redactor.add("plugin","craftAssetImages",plugin);
//# sourceMappingURL=CraftAssetImages.min.js.map
