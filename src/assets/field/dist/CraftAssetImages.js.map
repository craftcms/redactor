{"version":3,"file":"CraftAssetImages.js","mappings":"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","sources":["webpack:///./js/CraftAssetImages.js"],"sourcesContent":["var plugin = $.extend({}, Craft.Redactor.PluginBase, {\n  title: 'image',\n  apiTarget: 'plugin.craftAssetImages.showModal',\n  icon: '<i class=\"re-icon-image\"></i>',\n  transforms: [],\n  volumes: null,\n  allowAllUploaders: false,\n  defaultTransform: '',\n  modalState: {\n    selectedTransform: null,\n  },\n\n  showModal: function () {\n    this.saveSelection(this.app);\n\n    if (typeof this.assetSelectionModal === 'undefined') {\n      const criteria = {\n        siteId: this.elementSiteId,\n        kind: 'image',\n      };\n\n      if (this.allowAllUploaders) {\n        criteria.uploaderId = null;\n      }\n\n      this.assetSelectionModal = Craft.createElementSelectorModal(\n        'craft\\\\elements\\\\Asset',\n        {\n          storageKey: 'RedactorInput.ChooseImage',\n          multiSelect: true,\n          sources: this.volumes,\n          criteria: criteria,\n          onSelect: function (assets, transform) {\n            if (assets.length) {\n              this.restoreSelection(this.app);\n\n              const data = {};\n              const isMulti = assets.length > 1;\n\n              const processAssetUrls = function (assets, callback) {\n                const asset = assets.pop();\n                const isTransform = this._isTransformUrl(asset.url);\n\n                // If transform was selected or we don't have a default, no _real_ processing.\n                if (isTransform || this.defaultTransform.length == 0) {\n                  data['asset' + asset.id] = {\n                    url: this._buildAssetUrl(\n                      asset.id,\n                      asset.url,\n                      isTransform ? transform : this.defaultTransform\n                    ),\n                    id: asset.id,\n                  };\n\n                  if (assets.length) {\n                    processAssetUrls(assets, callback);\n                  } else {\n                    callback();\n                  }\n                  // Otherwise, get the transform url for the default transform.\n                } else {\n                  let url = this._getTransformUrl(\n                    asset.id,\n                    this.defaultTransform,\n                    function (url) {\n                      data['asset' + asset.id] = {\n                        url: this._buildAssetUrl(\n                          asset.id,\n                          url,\n                          this.defaultTransform\n                        ),\n                        id: asset.id,\n                      };\n\n                      if (assets.length) {\n                        processAssetUrls(assets, callback);\n                      } else {\n                        callback();\n                      }\n                    }.bind(this)\n                  );\n                }\n              }.bind(this);\n\n              processAssetUrls(\n                assets,\n                function () {\n                  this.app.api('module.image.insert', data);\n\n                  // If single asset selected, show the image modal.\n                  if (!isMulti) {\n                    this.modalState.selectedTransform = this.defaultTransform;\n                    this.app.api('module.image.open');\n                  }\n                }.bind(this)\n              );\n            }\n          }.bind(this),\n          transforms: this.transforms,\n          closeOtherModals: false,\n        }\n      );\n    } else {\n      this.assetSelectionModal.show();\n    }\n  },\n\n  setTransforms: function (transforms) {\n    this.transforms = transforms;\n  },\n\n  setDefaultTransform: function (transform) {\n    this.defaultTransform = transform;\n  },\n\n  setVolumes: function (volumes) {\n    this.volumes = volumes;\n  },\n\n  _buildAssetUrl: (assetId, assetUrl, transform) =>\n    assetUrl +\n    '#asset:' +\n    assetId +\n    ':' +\n    (transform ? 'transform:' + transform : 'url'),\n\n  _removeTransformFromUrl: (url) =>\n    url.replace(/(.*)(_[a-z0-9+].*\\/)(.*)/, '$1$3'),\n\n  _isTransformUrl: (url) => /(.*)(_[a-z0-9+].*\\/)(.*)/.test(url),\n\n  _getTransformUrl: function (assetId, handle, callback) {\n    var data = {\n      assetId: assetId,\n      handle: handle,\n    };\n\n    Craft.postActionRequest(\n      'assets/generate-transform',\n      data,\n      function (response, textStatus) {\n        if (textStatus === 'success') {\n          if (response.url) {\n            callback(response.url);\n          } else {\n            alert('There was an error generating the transform URL.');\n          }\n        }\n      }\n    );\n  },\n\n  _getAssetUrlComponents: (url) => {\n    const matches = url.match(\n      /(.*)#asset:(\\d+):(url|transform):?([a-zA-Z][a-zA-Z0-9_]*)?/\n    );\n    return matches\n      ? {\n          url: matches[1],\n          assetId: matches[2],\n          transform: matches[3] !== 'url' ? matches[4] : null,\n        }\n      : null;\n  },\n\n  onmodal: {\n    imageedit: {\n      open: function (modal, form) {\n        this.registerCmdS(\n          () => {\n            // Seems to be the simplest way.\n            const imageModule = this.app.module.image;\n            const modalModule = this.app.module.modal;\n            imageModule._save(modalModule.$modal, modalModule.$modalForm);\n          },\n          () => {\n            this.app.api('module.modal.close');\n          }\n        );\n\n        const parts = this._getAssetUrlComponents(\n          this.app.module.image.$image.$element.nodes[0].src\n        );\n\n        if (!parts) {\n          return;\n        }\n\n        let {transform} = parts;\n\n        if (!transform || !transform.length) {\n          transform = this.defaultTransform;\n        } else {\n          this.modalState.selectedTransform = transform;\n        }\n\n        const options = [{handle: '', name: 'No transform'}].concat(\n          this.transforms\n        );\n\n        const $select = $('<select id=\"modal-image-transform\"></select>').on(\n          'change',\n          function (ev) {\n            this.modalState.selectedTransform = $(ev.currentTarget).val();\n          }.bind(this)\n        );\n\n        for (optionIndex in options) {\n          let option = options[optionIndex];\n          let selected = transform && option.handle == transform;\n          $select.append(\n            '<option value=\"' +\n              option.handle +\n              '\"' +\n              (selected ? ' selected=\"selected\"' : '') +\n              '>' +\n              option.name +\n              '</option>'\n          );\n        }\n\n        const $formItem = $(\n          '<div class=\"form-item form-item-transform\"><label for=\"modal-image-transform\">Transform</label></div>'\n        ).append($select);\n\n        $(form.nodes[0]).append($formItem);\n      },\n\n      close: function () {\n        Garnish.shortcutManager.removeLayer();\n      },\n    },\n  },\n\n  onimage: {\n    changed: function (image) {\n      const $image = $(image.$element.nodes[0]);\n      const parts = this._getAssetUrlComponents($image.attr('src'));\n      const newTransform = this.modalState.selectedTransform;\n\n      if (!parts) {\n        return;\n      }\n\n      const {transform, assetId, url} = parts;\n\n      if (transform == newTransform) {\n        return;\n      }\n\n      $image.fadeTo(100, 0.2);\n\n      if (newTransform.length) {\n        this._getTransformUrl(\n          assetId,\n          newTransform,\n          function (url) {\n            $image.prop('src', this._buildAssetUrl(assetId, url, newTransform));\n            $image.stop().fadeTo(0, 1);\n          }.bind(this)\n        );\n      } else {\n        const pattern = new RegExp('(.*)(_' + transform + '.*/)(.*)');\n        $image.prop(\n          'src',\n          this._buildAssetUrl(\n            assetId,\n            this._removeTransformFromUrl(url),\n            newTransform\n          )\n        );\n        $image.stop().fadeTo(0, 1);\n      }\n    },\n  },\n});\n\n(function ($R) {\n  $R.add('plugin', 'craftAssetImages', plugin);\n})(Redactor);\n"],"names":["plugin","$","extend","Craft","Redactor","PluginBase","title","apiTarget","icon","transforms","volumes","allowAllUploaders","defaultTransform","modalState","selectedTransform","showModal","saveSelection","app","assetSelectionModal","criteria","siteId","elementSiteId","kind","uploaderId","createElementSelectorModal","storageKey","multiSelect","sources","onSelect","assets","transform","length","restoreSelection","data","isMulti","processAssetUrls","callback","asset","pop","isTransform","_isTransformUrl","url","id","_buildAssetUrl","_getTransformUrl","bind","api","closeOtherModals","show","setTransforms","setDefaultTransform","setVolumes","assetId","assetUrl","_removeTransformFromUrl","replace","test","handle","postActionRequest","response","textStatus","alert","_getAssetUrlComponents","matches","match","onmodal","imageedit","open","modal","form","registerCmdS","imageModule","module","image","modalModule","_save","$modal","$modalForm","parts","$image","$element","nodes","src","options","name","concat","$select","on","ev","currentTarget","val","optionIndex","option","selected","append","$formItem","close","Garnish","shortcutManager","removeLayer","onimage","changed","attr","newTransform","fadeTo","prop","stop","pattern","RegExp","$R","add"],"sourceRoot":""}