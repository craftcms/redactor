!function(){var e=$.extend({},Craft.Redactor.PluginBase,{title:"image",apiTarget:"plugin.craftAssetImages.showModal",icon:'<i class="re-icon-image"></i>',transforms:[],volumes:null,allowAllUploaders:!1,defaultTransform:"",modalState:{selectedTransform:null},showModal:function(){if(this.saveSelection(this.app),void 0===this.assetSelectionModal){var e={siteId:this.elementSiteId,kind:"image"};this.allowAllUploaders&&(e.uploaderId=null),this.assetSelectionModal=Craft.createElementSelectorModal("craft\\elements\\Asset",{storageKey:"RedactorInput.ChooseImage",multiSelect:!0,sources:this.volumes,criteria:e,onSelect:function(e,t){if(e.length){this.restoreSelection(this.app);var s={},a=e.length>1,r=function(e,a){var n=e.pop(),o=this._isTransformUrl(n.url);o||0==this.defaultTransform.length?(s["asset"+n.id]={url:this._buildAssetUrl(n.id,n.url,o?t:this.defaultTransform),id:n.id},e.length?r(e,a):a()):this._getTransformUrl(n.id,this.defaultTransform,function(t){s["asset"+n.id]={url:this._buildAssetUrl(n.id,t,this.defaultTransform),id:n.id},e.length?r(e,a):a()}.bind(this))}.bind(this);r(e,function(){this.app.api("module.image.insert",s),a||(this.modalState.selectedTransform=this.defaultTransform,this.app.api("module.image.open"))}.bind(this))}}.bind(this),transforms:this.transforms,closeOtherModals:!1})}else this.assetSelectionModal.show()},setTransforms:function(e){this.transforms=e},setDefaultTransform:function(e){this.defaultTransform=e},setVolumes:function(e){this.volumes=e},_buildAssetUrl:function(e,t,s){return t+"#asset:"+e+":"+(s?"transform:"+s:"url")},_removeTransformFromUrl:function(e){return e.replace(/(^|\/)(_[^\/]+\/)([^\/]+)$/,"$1$3")},_isTransformUrl:function(e){return/(^|\/)_[^\/]+\/[^\/]+$/.test(e)},_getTransformUrl:function(e,t,s){var a={assetId:e,handle:t};Craft.sendActionRequest("POST","assets/generate-transform",{data:a}).then((function(e){var t=e.data&&e.data.url;t&&s(t)})).catch((function(e){e.response,alert("There was an error generating the transform URL.")}))},_getAssetUrlComponents:function(e){var t=e.match(/(.*)#asset:(\d+):(url|transform):?([a-zA-Z][a-zA-Z0-9_]*)?/);return t?{url:t[1],assetId:t[2],transform:"url"!==t[3]?t[4]:null}:null},onmodal:{imageedit:{open:function(e,t){var s=this;this.registerCmdS((function(){var e=s.app.module.image,t=s.app.module.modal;e._save(t.$modal,t.$modalForm)}),(function(){s.app.api("module.modal.close")}));var a=this._getAssetUrlComponents(this.app.module.image.$image.$element.nodes[0].src);if(a){var r=a.transform;r&&r.length?this.modalState.selectedTransform=r:r=this.defaultTransform;var n=[{handle:"",name:"No transform"}].concat(this.transforms),o=$('<select id="modal-image-transform"></select>').on("change",function(e){this.modalState.selectedTransform=$(e.currentTarget).val()}.bind(this));for(optionIndex in n){var i=n[optionIndex],l=r&&i.handle==r;o.append('<option value="'+i.handle+'"'+(l?' selected="selected"':"")+">"+i.name+"</option>")}var d=$('<div class="form-item form-item-transform"><label for="modal-image-transform">Transform</label></div>').append(o);$(t.nodes[0]).append(d)}},close:function(){Garnish.shortcutManager.removeLayer()}}},onimage:{changed:function(e){var t=$(e.$element.nodes[0]),s=this._getAssetUrlComponents(t.attr("src")),a=this.modalState.selectedTransform;if(s){var r=s.transform,n=s.assetId,o=s.url;r!=a&&(t.fadeTo(100,.2),a.length?this._getTransformUrl(n,a,function(e){t.prop("src",this._buildAssetUrl(n,e,a)),t.stop().fadeTo(0,1)}.bind(this)):(new RegExp("(.*)(_"+r+".*/)(.*)"),t.prop("src",this._buildAssetUrl(n,this._removeTransformFromUrl(o),a)),t.stop().fadeTo(0,1)))}}}});Redactor.add("plugin","craftAssetImages",e)}();
//# sourceMappingURL=CraftAssetImages.js.map