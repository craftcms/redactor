{"version":3,"file":"CraftElementLinks.js","mappings":"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","sources":["webpack:///./js/CraftElementLinks.js"],"sourcesContent":["var plugin = $.extend({}, Craft.Redactor.PluginBase, {\n  linkOptions: [],\n  existingText: '',\n  hack: null,\n  allSites: {},\n  modalState: {\n    selectedLink: {\n      text: null,\n      url: null,\n    },\n  },\n\n  // Do nothing on start.\n  start: function () {},\n  showModal: function (args, zIndex) {\n    let refHandle = args.refHandle,\n      callback = args.callback;\n\n    this.saveSelection(this.app);\n\n    // Create a new one each time because Redactor creates a new one and we can't reuse the references.\n    const modal = Craft.createElementSelectorModal(args.elementType, {\n      storageKey: 'RedactorInput.LinkTo.' + args.elementType,\n      sources: args.sources,\n      criteria: args.criteria,\n      defaultSiteId: this.elementSiteId,\n      autoFocusSearchBox: false,\n      onSelect: $.proxy(function (elements) {\n        if (elements.length) {\n          this.restoreSelection(this.app);\n          const element = elements[0];\n          const selectedText = this.app.selection.getText();\n          this.modalState.selectedLink = {\n            url:\n              element.url +\n              '#' +\n              refHandle +\n              ':' +\n              element.id +\n              '@' +\n              element.siteId,\n            text: selectedText.length > 0 ? selectedText : element.label,\n          };\n\n          this.app.api('module.link.open');\n        }\n      }, this),\n      closeOtherModals: false,\n    });\n  },\n\n  setLinkOptions: function (linkOptions) {\n    this.linkOptions = linkOptions;\n  },\n\n  onmodal: {\n    link: {\n      open: function (modal, form) {\n        // Prevent Redactor from aggressively refocusing, when we don't want it to.\n        this.hack = modal.app.editor.focus;\n        modal.app.editor.focus = () => null;\n\n        $form = $(form.nodes);\n\n        if (this.modalState.selectedLink.url) {\n          $form.find('input[name=url]').val(this.modalState.selectedLink.url);\n        }\n\n        if (this.modalState.selectedLink.text) {\n          $form.find('input[name=text]').val(this.modalState.selectedLink.text);\n        }\n\n        this.modalState.selectedLink = {\n          text: null,\n          url: null,\n        };\n\n        let existingUrl = $form.find('input[name=url]').val();\n\n        // Only add site selector if it looks like an element reference link\n        const refHandlesRegex = Craft.Redactor.localizedRefHandles.join('|');\n        const match = existingUrl.match(\n          new RegExp(`(#(?:${refHandlesRegex}):\\\\d+)(?:@(\\\\d+))?`)\n        );\n\n        if (match) {\n          let siteOptions = this.allSites;\n          const existingSiteId = match[2] ? parseInt(match[2], 10) : null;\n\n          const $select = $('<select id=\"modal-site-selector\"></select>').on(\n            'change',\n            (ev) => {\n              const selectedSiteId = parseInt($(ev.currentTarget).val(), 10);\n              let ref = match[1];\n\n              if (selectedSiteId) {\n                ref += `@${selectedSiteId}`;\n              }\n\n              const newUrl = existingUrl.replace(match[0], ref);\n              $form.find('input[name=url]').val(newUrl);\n            }\n          );\n\n          let selected = !existingSiteId ? ' selected=\"selected\"' : '';\n          $select.append(\n            `<option value=\"0\"${selected}>${Craft.t(\n              'app',\n              'Link to the current site'\n            )}</option>`\n          );\n\n          for ([siteId, siteName] of Object.entries(siteOptions)) {\n            let selected =\n              existingSiteId === parseInt(siteId, 10)\n                ? ' selected=\"selected\"'\n                : '';\n            $select.append(\n              `<option value=\"${siteId}\"${selected}>${siteName}</option>`\n            );\n          }\n\n          const $formItem = $(\n            '<div class=\"form-item form-item-site\"><label for=\"modal-site-selector\">Site</label></div>'\n          ).append($select);\n\n          $(form.nodes[0]).append($formItem);\n        }\n      },\n      close: function (modal) {\n        // Revert the functionality.\n        modal.app.editor.focus = this.hack;\n        this.hack = null;\n      },\n    },\n  },\n\n  setLinkOptions: function (linkOptions) {\n    var button = this.app.toolbar.getButton('link'),\n      dropdown = button.getDropdown(),\n      items = dropdown.items,\n      newList = {},\n      counter = 0;\n\n    for (var option in linkOptions) {\n      option = linkOptions[option];\n      newList['custom' + ++counter] = {\n        title: option.optionTitle,\n        api: 'plugin.craftElementLinks.showModal',\n        args: {\n          elementType: option.elementType,\n          refHandle: option.refHandle,\n          sources: option.sources,\n          criteria: option.criteria,\n        },\n      };\n    }\n\n    button.setDropdown($.extend(newList, items));\n  },\n\n  setAllSites: function (allSites) {\n    this.allSites = allSites;\n  },\n});\n\n(function ($R) {\n  $R.add('plugin', 'craftElementLinks', plugin);\n})(Redactor);\n"],"names":["plugin","$","extend","Craft","Redactor","PluginBase","linkOptions","existingText","hack","allSites","modalState","selectedLink","text","url","start","showModal","args","zIndex","refHandle","callback","this","saveSelection","app","createElementSelectorModal","elementType","storageKey","sources","criteria","defaultSiteId","elementSiteId","autoFocusSearchBox","onSelect","proxy","elements","length","restoreSelection","element","selectedText","selection","getText","id","siteId","label","api","closeOtherModals","setLinkOptions","onmodal","link","open","modal","form","editor","focus","$form","nodes","find","val","existingUrl","refHandlesRegex","localizedRefHandles","join","match","RegExp","siteOptions","existingSiteId","parseInt","$select","on","ev","selectedSiteId","currentTarget","ref","newUrl","replace","selected","append","t","Object","entries","siteName","$formItem","close","button","toolbar","getButton","items","getDropdown","newList","counter","option","title","optionTitle","setDropdown","add"],"sourceRoot":""}