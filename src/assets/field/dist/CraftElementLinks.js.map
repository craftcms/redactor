{"version":3,"file":"CraftElementLinks.js","mappings":"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","sources":["webpack:///./js/CraftElementLinks.js"],"sourcesContent":["var plugin = $.extend({}, Craft.Redactor.PluginBase, {\n  linkOptions: [],\n  existingText: '',\n  hack: null,\n  allSites: {},\n  modalState: {\n    selectedLink: {\n      text: null,\n      url: null,\n    },\n  },\n\n  // Do nothing on start.\n  start: function () {},\n  showModal: function (args, zIndex) {\n    let refHandle = args.refHandle,\n      callback = args.callback;\n\n    this.saveSelection(this.app);\n\n    // Create a new one each time because Redactor creates a new one and we can't reuse the references.\n    const modal = Craft.createElementSelectorModal(args.elementType, {\n      storageKey: 'RedactorInput.LinkTo.' + args.elementType,\n      sources: args.sources,\n      criteria: args.criteria,\n      defaultSiteId: this.elementSiteId,\n      autoFocusSearchBox: false,\n      onSelect: $.proxy(function (elements) {\n        if (elements.length) {\n          this.restoreSelection(this.app);\n          const element = elements[0];\n          const selectedText = this.app.selection.getText();\n          this.modalState.selectedLink = {\n            url:\n              element.url +\n              '#' +\n              refHandle +\n              ':' +\n              element.id +\n              '@' +\n              element.siteId,\n            text: selectedText.length > 0 ? selectedText : element.label,\n          };\n\n          this.app.api('module.link.open');\n        }\n      }, this),\n      closeOtherModals: false,\n    });\n  },\n\n  setLinkOptions: function (linkOptions) {\n    this.linkOptions = linkOptions;\n  },\n\n  onmodal: {\n    link: {\n      open: function (modal, form) {\n        // Prevent Redactor from aggressively refocusing, when we don't want it to.\n        this.hack = modal.app.editor.focus;\n        modal.app.editor.focus = () => null;\n\n        $form = $(form.nodes);\n\n        if (this.modalState.selectedLink.url) {\n          $form.find('input[name=url]').val(this.modalState.selectedLink.url);\n        }\n\n        if (this.modalState.selectedLink.text) {\n          $form.find('input[name=text]').val(this.modalState.selectedLink.text);\n        }\n\n        this.modalState.selectedLink = {\n          text: null,\n          url: null,\n        };\n\n        let elementUrl = $form.find('input[name=url]').val();\n\n        // Only add site selector if it looks like an element reference link\n        if (elementUrl.match(/#(category|entry|product):\\d+/)) {\n          let siteOptions = this.allSites;\n          let selectedSite = 0;\n\n          if (elementUrl.split('@').length > 1) {\n            selectedSite = parseInt(elementUrl.split('@').pop(), 10);\n          }\n\n          const $select = $('<select id=\"modal-site-selector\"></select>').on(\n            'change',\n            function (ev) {\n              let existingUrl = $form.find('input[name=url]').val();\n              const selectedSiteId = parseInt($(ev.currentTarget).val(), 10);\n\n              if (existingUrl.match(/.*(@\\d+)$/)) {\n                let urlParts = existingUrl.split('@');\n                urlParts.pop();\n                existingUrl = urlParts.join('@');\n              }\n\n              if (selectedSiteId) {\n                existingUrl += '@' + selectedSiteId;\n              }\n\n              $form.find('input[name=url]').val(existingUrl);\n            }.bind(this)\n          );\n\n          let selected = selectedSite === 0 ? ' selected=\"selected\"' : '';\n          $select.append(`<option value=\"0\"${selected}>Multisite</option>`);\n\n          for ([siteId, siteName] of Object.entries(siteOptions)) {\n            let selected =\n              selectedSite === parseInt(siteId, 10)\n                ? ' selected=\"selected\"'\n                : '';\n            $select.append(\n              `<option value=\"${siteId}\"${selected}>${siteName}</option>`\n            );\n          }\n\n          const $formItem = $(\n            '<div class=\"form-item form-item-site\"><label for=\"modal-site-selector\">Site</label></div>'\n          ).append($select);\n\n          $(form.nodes[0]).append($formItem);\n        }\n      },\n      close: function (modal) {\n        // Revert the functionality.\n        modal.app.editor.focus = this.hack;\n        this.hack = null;\n      },\n    },\n  },\n\n  setLinkOptions: function (linkOptions) {\n    var button = this.app.toolbar.getButton('link'),\n      dropdown = button.getDropdown(),\n      items = dropdown.items,\n      newList = {},\n      counter = 0;\n\n    for (var option in linkOptions) {\n      option = linkOptions[option];\n      newList['custom' + ++counter] = {\n        title: option.optionTitle,\n        api: 'plugin.craftElementLinks.showModal',\n        args: {\n          elementType: option.elementType,\n          refHandle: option.refHandle,\n          sources: option.sources,\n          criteria: option.criteria,\n        },\n      };\n    }\n\n    button.setDropdown($.extend(newList, items));\n  },\n\n  setAllSites: function (allSites) {\n    this.allSites = allSites;\n  },\n});\n\n(function ($R) {\n  $R.add('plugin', 'craftElementLinks', plugin);\n})(Redactor);\n"],"names":["plugin","$","extend","Craft","Redactor","PluginBase","linkOptions","existingText","hack","allSites","modalState","selectedLink","text","url","start","showModal","args","zIndex","refHandle","callback","saveSelection","app","modal","createElementSelectorModal","elementType","storageKey","sources","criteria","defaultSiteId","elementSiteId","autoFocusSearchBox","onSelect","proxy","elements","length","restoreSelection","element","selectedText","selection","getText","id","siteId","label","api","closeOtherModals","setLinkOptions","onmodal","link","open","form","editor","focus","$form","nodes","find","val","elementUrl","match","siteOptions","selectedSite","split","parseInt","pop","$select","on","ev","existingUrl","selectedSiteId","currentTarget","urlParts","join","bind","selected","append","Object","entries","siteName","$formItem","close","button","toolbar","getButton","dropdown","getDropdown","items","newList","counter","option","title","optionTitle","setDropdown","$R","add"],"sourceRoot":""}